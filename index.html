<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>1ì¼ 1ì¹­ì°¬</title>
<style>
  :root{--accent:#6b4eff; --bg1:#f7f3ff; --bg2:#ffeef7}
  *{box-sizing:border-box}
  body{
    margin:0;min-height:100vh;
    display:flex;align-items:center;justify-content:center;
    background:linear-gradient(135deg,var(--bg1),var(--bg2));
    font-family: 'Noto Sans KR', system-ui, -apple-system, 'Segoe UI', Roboto;
    padding:24px;
  }
  .card{
    width:100%;max-width:460px;background:#fff;border-radius:20px;
    padding:28px;box-shadow:0 12px 30px rgba(15,23,42,0.12);text-align:center;
  }
  h1{margin:0 0 18px;font-size:28px;color:var(--accent)}
  .muted{color:#6b7280;font-size:14px;margin-bottom:18px}
  .btn{display:inline-block;border:0;padding:12px 18px;border-radius:12px;font-weight:600;cursor:pointer}
  .btn-upload{background:#ece8ff;color:var(--accent);margin-bottom:12px}
  .btn-generate{background:var(--accent);color:#fff;width:100%;font-size:16px;padding:14px 18px}
  #preview{max-width:240px;border-radius:12px;margin:12px auto 6px;display:none;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
  #emoji{font-size:48px;margin-top:12px}
  #compliment{font-size:18px;margin-top:10px;line-height:1.4}
  #moreBtn{margin-top:14px;background:#5a40e6;color:#fff;padding:10px 14px;border-radius:10px}
  small.hint{display:block;margin-top:10px;color:#9aa0b0}
  canvas{display:none}
</style>
</head>
<body>

<div class="card">
  <h1>1ì¼ 1ì¹­ì°¬</h1>
  <div class="muted">ì‚¬ì§„ì„ ì²¨ë¶€í•˜ë©´ ì´ë¯¸ì§€ ë¶„ì„ì„ í†µí•´ ìƒí™©ì— ë§ëŠ” ì¹­ì°¬ì„ ìƒì„±í•´ì¤„ê²Œ.</div>

  <input type="file" id="fileInput" accept="image/*" style="display:none">
  <button class="btn btn-upload" id="uploadBtn">ğŸ“· ì‚¬ì§„ ì²¨ë¶€í•˜ê¸°</button>
  <img id="preview" alt="preview">

  <button class="btn btn-generate" id="generateBtn">ì¹­ì°¬ ìƒì„±í•˜ê¸°</button>

  <div id="complimentArea" style="display:none">
    <div id="emoji">âœ¨</div>
    <div id="compliment">ì˜¤ëŠ˜ë„ ë©‹ì ¸ìš”!</div>
    <button id="moreBtn">í•˜ë‚˜ ë” ìƒì„±í•˜ê¸°</button>
    <small class="hint" id="analysisHint"></small>
  </div>
</div>

<!-- ë‚´ë¶€ í•©ì„± ì‚¬ìš´ë“œ ì‚¬ìš© (Web Audio API) -->
<script>
/* ------------------------------
   ì†Œë¦¬: Web Audio APIë¡œ ì–‡ì€ ì¢…ì†Œë¦¬ í•©ì„±
   (ë¸Œë¼ìš°ì €ì˜ autoplay ì •ì±…ì„ í”¼í•˜ë ¤ë©´ ì‚¬ìš©ìì˜ í´ë¦­(ë²„íŠ¼)ì—ì„œ ì¬ìƒ)
   ------------------------------ */
function playCalmBell() {
  try {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const now = ctx.currentTime;

    // ê°„ë‹¨í•œ ë©œë¡œë””: ë‘ ë²ˆì˜ ì§§ì€ ì¢…
    function tone(timeOffset, freq, dur, gainVal) {
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.type = 'sine';
      osc.frequency.value = freq;
      gain.gain.value = 0;
      osc.connect(gain);
      gain.connect(ctx.destination);

      const start = now + timeOffset;
      gain.gain.setValueAtTime(0, start);
      gain.gain.linearRampToValueAtTime(gainVal, start + 0.01);
      gain.gain.exponentialRampToValueAtTime(0.0001, start + timeOffset + dur);
      osc.start(start);
      osc.stop(start + timeOffset + dur + 0.02);
    }

    tone(0, 880, 0.22, 0.08);   // ë†’ì€ ë§‘ì€ í†¤ (ì§§ê²Œ)
    tone(0.28, 660, 0.22, 0.06); // ë‘ë²ˆì§¸ í†¤ (ì¡°ê¸ˆ ë‚®ê²Œ)
  } catch (e) {
    // ì•ˆì „í•˜ê²Œ ì‹¤íŒ¨ ë¬´ì‹œ
    // console.log('Audio failed', e);
  }
}

/* ------------------------------
   ì´ë¯¸ì§€ ë¶„ì„: ì—…ë¡œë“œ ëœ ì´ë¯¸ì§€ë¥¼ canvasì— ê·¸ë ¤ì„œ
   - í”¼ë¶€í†¤ ë¹„ìœ¨ -> people
   - ë…¹ìƒ‰ í”½ì…€ ë¹„ìœ¨ -> outdoor
   - ë°ê¸°/í…ìŠ¤ì²˜ ê¸°ë°˜ íŒíŠ¸ -> indoor/objects
   ê°„ë‹¨í•œ íœ´ë¦¬ìŠ¤í‹±ìœ¼ë¡œ ì¹´í…Œê³ ë¦¬ ì¶”ì •
   ------------------------------ */
const fileInput = document.getElementById('fileInput');
const uploadBtn = document.getElementById('uploadBtn');
const preview = document.getElementById('preview');
const generateBtn = document.getElementById('generateBtn');
const complimentArea = document.getElementById('complimentArea');
const emojiEl = document.getElementById('emoji');
const complimentEl = document.getElementById('compliment');
const moreBtn = document.getElementById('moreBtn');
const analysisHint = document.getElementById('analysisHint');

let lastCategory = 'default';
let hasPhoto = false;

uploadBtn.addEventListener('click', () => fileInput.click());
fileInput.addEventListener('change', async (e) => {
  const f = e.target.files[0];
  if (!f) return;
  hasPhoto = true;
  const url = URL.createObjectURL(f);
  preview.src = url;
  preview.style.display = 'block';
  // small delay to ensure image loads
  preview.onload = () => {
    analyzeImage(preview).then(cat => {
      lastCategory = cat;
      analysisHint.innerText = 'ì´ë¯¸ì§€ ë¶„ì„ ê²°ê³¼: ' + cat;
    });
  };
});

/* ì´ë¯¸ì§€ ë¶„ì„ í•¨ìˆ˜ */
async function analyzeImage(imgEl) {
  const canvas = document.createElement('canvas');
  const max = 240;
  const ratio = Math.min(max / imgEl.naturalWidth, max / imgEl.naturalHeight, 1);
  canvas.width = Math.floor(imgEl.naturalWidth * ratio);
  canvas.height = Math.floor(imgEl.naturalHeight * ratio);
  const ctx = canvas.getContext('2d');
  ctx.drawImage(imgEl, 0, 0, canvas.width, canvas.height);
  
  const { width, height } = canvas;
  const { data } = ctx.getImageData(0, 0, width, height);
  const total = width * height;

  let warm = 0, cool = 0;
  let brightnessSum = 0;
  let edgeCount = 0;
  let uniformAreas = 0;

  // ë’·ëª¨ìŠµ ì‚¬ëŒ ì¸ì‹ì„ ìœ„í•œ ë³€ìˆ˜
  let darkCluster = 0;      // ë¨¸ë¦¬ì¹´ë½ ê°€ëŠ¥ì„±
  let torsoCluster = 0;     // ëª¸í†µ ê°€ëŠ¥ì„±
  let shoulderPattern = 0;  // ì–´ê¹¨ íŒ¨í„´
  
  const idx = (x, y) => (y * width + x) * 4;

  for (let y = 1; y < height - 1; y++) {
    for (let x = 1; x < width - 1; x++) {
      const i = idx(x, y);
      const r = data[i], g = data[i+1], b = data[i+2];
      
      brightnessSum += (0.299*r + 0.587*g + 0.114*b);

      // í†¤ íŒë‹¨
      if (r > g + 20 && r > b + 20) warm++;
      if (b > r + 15 || g > r + 15) cool++;

      // ì—ì§€(ìœ¤ê³½) ì„¸ê¸°
      const right = idx(x+1, y);
      const diff = Math.abs(r - data[right]) + Math.abs(g - data[right+1]) + Math.abs(b - data[right+2]);
      if (diff > 60) edgeCount++;

      // ë„“ê³  ë‹¨ìƒ‰ì¸ ë©´ì (ì‹¤ë‚´ ë²½/ì²œì¥) íŒì •
      const up = idx(x, y-1);
      const diffUp = Math.abs(r - data[up]) + Math.abs(g - data[up+1]) + Math.abs(b - data[up+2]);
      if (diffUp < 25) uniformAreas++;

      // ì‚¬ëŒ ë’·ëª¨ìŠµ íŠ¹ì§• íƒì§€
      const luminance = (r + g + b) / 3;

      // 1) ë¨¸ë¦¬ì¹´ë½ í›„ë³´: ë§¤ìš° ì–´ë‘ìš´ ë©ì–´ë¦¬
      if (luminance < 55) darkCluster++;

      // 2) ëª¸í†µ í›„ë³´: ì¤‘ê°„ ë°ê¸° + ì¼ì •í•œ ìƒ‰
      if (luminance > 60 && luminance < 160 && diffUp < 40) torsoCluster++;

      // 3) ì–´ê¹¨ ë¼ì¸: ì¢Œìš° í”½ì…€ ëŒ€ë¹„ê°€ ë¯¸ì„¸í•˜ê²Œ curved
      const left = idx(x-1, y);
      const leftDiff = Math.abs(r - data[left]) + Math.abs(g - data[left+1]) + Math.abs(b - data[left+2]);
      if (diffUp > 20 && leftDiff > 20 && diff < 120) shoulderPattern++;
    }
  }

  const warmRatio = warm / total;
  const coolRatio = cool / total;
  const brightness = brightnessSum / total;
  const edgeRatio = edgeCount / total;
  const uniformRatio = uniformAreas / total;

  const hairRatio = darkCluster / total;
  const torsoRatio = torsoCluster / total;
  const shoulderRatio = shoulderPattern / total;

  /* -----------------------------
       1) ì‚¬ëŒ ë’·ëª¨ìŠµ ì¸ì‹
     ----------------------------- */
  const looksLikeBackPerson =
    hairRatio > 0.010 &&       // ë¨¸ë¦¬ì¹´ë½ ë¹„ìœ¨
    torsoRatio > 0.045 &&      // ëª¸í†µ íŒ¨í„´
    shoulderRatio > 0.015 &&   // ì–´ê¹¨ ê³¡ì„ 
    edgeRatio > 0.020;         // ì „ì²´ ìœ¤ê³½ ì„¸ê¸°

  if (looksLikeBackPerson) {
    return "people";
  }

  /* -----------------------------
       2) ì¼ë°˜ì ì¸ ì‚¬ëŒ ì¸ì‹
     ----------------------------- */
  if (hairRatio > 0.02 && torsoRatio > 0.03) {
    return "people";
  }

  /* -----------------------------
       3) ì‹¤ë‚´ ì‚¬ì§„ íŒë‹¨
     ----------------------------- */
  const indoorByLighting =
    warmRatio > 0.25 || brightness < 140;

  const indoorByGeometry =
    uniformRatio > 0.20 || edgeRatio < 0.04;

  if (indoorByLighting && indoorByGeometry) {
    return "indoor";
  }

  /* -----------------------------
       4) ì•¼ì™¸ ì‚¬ì§„ íŒë‹¨
     ----------------------------- */
  if (coolRatio > 0.20 && brightness > 110) {
    return "outdoor";
  }

  /* -----------------------------
       5) ì‚¬ë¬¼(ê¸°ë³¸)
     ----------------------------- */
  return "objects";
}

/* ì¹­ì°¬ í’€ (ì¹´í…Œê³ ë¦¬ë³„) */
const compliments = {
  people: [
    {text: 'í•¨ê»˜í•œ ìˆœê°„ë“¤ì´ ë„ˆë¥¼ ë” ë¹›ë‚˜ê²Œ í•´!', emoji:'ğŸ¤'},
    {text: 'ë„¤ í‘œì •ì—ì„œ ë”°ëœ»í•¨ì´ ëŠê»´ì ¸. ì˜¤ëŠ˜ë„ ë©‹ì ¸!', emoji:'ğŸ˜Š'},
    {text: 'ì¢‹ì€ ì‚¬ëŒë“¤ê³¼ì˜ ì‹œê°„ì´ ë„ ë” ë‹¨ë‹¨í•˜ê²Œ í•´ì¤˜.', emoji:'ğŸ’–'}
  ],
  outdoor: [
    {text: 'ìì—°ê³¼ ì˜ ì–´ìš¸ë¦¬ëŠ” í•˜ë£¨ì˜€ë„¤. ìƒì¾Œí•˜ê²Œ ì‰¬ì–´!', emoji:'ğŸŒ¿'},
    {text: 'ë°”ê¹¥ì˜ í™œê¸°ê°€ ë„ˆí•œí…Œë„ ì „í•´ì§€ê¸¸ ë°”ë¼!', emoji:'â˜€ï¸'},
    {text: 'ë©‹ì§„ í’ê²½ì´ë„¤ â€” ë„¤ í•˜ë£¨ê°€ ë” ë¹›ë‚˜ê¸¸!', emoji:'ğŸŒ¤ï¸'}
  ],
  indoor: [
    {text: 'ì•„ëŠ‘í•œ ë¶„ìœ„ê¸°ë„¤ â€” ì˜¤ëŠ˜ì€ í¸íˆ ì‰¬ì–´ë„ ì¢‹ì•„.', emoji:'ğŸ›‹ï¸'},
    {text: 'í¬ê·¼í•œ ê³µê°„ì´ì•¼. ë„¤ê°€ í¸ì•ˆí•˜ê¸¸ ë°”ë„ê²Œ.', emoji:'ğŸŒ·'},
    {text: 'ì‚¬ì§„ì—ì„œ í‰ì˜¨í•¨ì´ ëŠê»´ì ¸. ì˜í•˜ê³  ìˆì–´!', emoji:'âœ¨'}
  ],
  objects: [
    {text: 'ì„¸ì‹¬í•œ ê°ê°ì´ ëŠê»´ì§€ëŠ” ì‚¬ì§„ì´ì•¼ â€” ë„ˆì˜ ì‹œì„ ì´ ë©‹ì ¸!', emoji:'ğŸ“¸'},
    {text: 'ì‘ì€ ë””í…Œì¼ì„ ì˜ ë‹´ì•„ë‚´ëŠ” ë„ˆ, ì •ë§ ëŒ€ë‹¨í•´!', emoji:'ğŸ¨'},
    {text: 'ì´ëŸ° ìˆœê°„ë“¤ì„ ë³´ëŠ” ë„¤ ëˆˆì´ íŠ¹ë³„í•´.', emoji:'ğŸ”'}
  ],
  default: [
    {text: 'ì˜¤ëŠ˜ë„ ì¶©ë¶„íˆ ì˜í•˜ê³  ìˆì–´!', emoji:'ğŸŒŸ'},
    {text: 'ë„¤ê°€ ìˆì–´ í•˜ë£¨ê°€ ë” ì¢‹ì•„ì¡Œì–´.', emoji:'ğŸ’›'},
    {text: 'ì‘ì€ ì¼ì—ë„ ë„ˆëŠ” ë¹›ë‚˜ê³  ìˆì–´.', emoji:'âœ¨'}
  ]
};

function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

/* ìƒì„± í•¸ë“¤ëŸ¬: ì‚¬ìš©ì í´ë¦­(ë²„íŠ¼)ìœ¼ë¡œ ì¬ìƒ + ë¶„ì„ê²°ê³¼ ê¸°ë°˜ ì¹­ì°¬ ì¶œë ¥ */
generateBtn.addEventListener('click', async () => {
  // ì†Œë¦¬ ì¬ìƒ (í•­ìƒ user gestureì—ì„œ í˜¸ì¶œë˜ë¯€ë¡œ ì •ìƒ ì¬ìƒ)
  playCalmBell();

  // ë§Œì•½ ì‚¬ì§„ì„ ì²¨ë¶€í•œ ìƒíƒœë¼ë©´ ì´ë¯¸ analyzeImageì—ì„œ lastCategoryê°€ ê°±ì‹ ë¨
  // but if user attached file but analyze didn't finish, attempt quick analysis if preview loaded
  if (hasPhoto && preview.complete && preview.naturalWidth) {
    // ensure analyzed
    try {
      lastCategory = await analyzeImage(preview);
      analysisHint.innerText = 'ì´ë¯¸ì§€ ë¶„ì„ ê²°ê³¼: ' + lastCategory;
    } catch(e){ lastCategory = 'default'}
  }

  const chosen = pick(compliments[lastCategory] || compliments.default);
  emojiEl.innerText = chosen.emoji;
  complimentEl.innerText = chosen.text;
  complimentArea.style.display = 'block';
});

moreBtn.addEventListener('click', () => {
  // ì¬ìƒ + ìƒˆ ì¹­ì°¬
  playCalmBell();
  const chosen = pick(compliments[lastCategory] || compliments.default);
  emojiEl.innerText = chosen.emoji;
  complimentEl.innerText = chosen.text;
});
</script>
</body>
</html>
